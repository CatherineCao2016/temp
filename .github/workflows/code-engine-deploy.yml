name: IBM Code Engine CI/CD Pipeline

# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
# Before this workflow can run, you must add the following secret to your GitHub repository:
#
# 1. Go to: Settings → Secrets and variables → Actions → New repository secret
# 2. Add secret:
#    Name: IBM_CLOUD_API_KEY
#    Value: Your IBM Cloud API key (the same one used in terraform.tfvars)
#
# To create an IBM Cloud API key if you don't have one:
#   ibmcloud login
#   ibmcloud iam api-key-create payment-app-cicd-key -d "API key for payment app CI/CD"
# ============================================================================

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IBM_CLOUD_REGION: us-south
  IBM_CLOUD_RESOURCE_GROUP: Default
  CE_PROJECT: payment-app-project
  CE_APP: payment-app
  CE_BUILD: payment-app-build
  IMAGE_NAME: us.icr.io/payment-app-ns/payment-app:latest
  HEALTH_ENDPOINT: https://payment-app.26rs7vqmzosm.us-south.codeengine.appdomain.cloud/actuator/health
  JAVA_VERSION: '11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      
      - name: Run Maven tests
        run: mvn test
      
      - name: Generate test report
        if: always()
        continue-on-error: true
        uses: dorny/test-reporter@v1
        with:
          name: Maven Tests
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

  build-deploy:
    name: Build and Deploy to Code Engine
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud --version
          ibmcloud plugin install code-engine -f
      
      - name: Authenticate to IBM Cloud
        run: |
          ibmcloud login --apikey "${{ secrets.IBM_CLOUD_API_KEY }}" -r ${{ env.IBM_CLOUD_REGION }} -g ${{ env.IBM_CLOUD_RESOURCE_GROUP }}
          ibmcloud ce project select --name ${{ env.CE_PROJECT }}
      
      - name: Submit Code Engine build run
        id: submit_build
        run: |
          BUILD_RUN_NAME="payment-app-buildrun-${{ github.run_number }}"
          echo "build_run_name=${BUILD_RUN_NAME}" >> $GITHUB_OUTPUT
          
          echo "Submitting build run: ${BUILD_RUN_NAME}"
          ibmcloud ce buildrun submit --build ${{ env.CE_BUILD }} --name ${BUILD_RUN_NAME}
          
          echo "Build run submitted successfully"
      
      - name: Wait for build to complete
        run: |
          BUILD_RUN_NAME="${{ steps.submit_build.outputs.build_run_name }}"
          echo "Waiting for build run ${BUILD_RUN_NAME} to complete..."
          
          MAX_WAIT=600  # 10 minutes in seconds
          INTERVAL=10   # Check every 10 seconds
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(ibmcloud ce buildrun get -n ${BUILD_RUN_NAME} --output json | jq -r '.status.conditions[] | select(.type=="Succeeded") | .status')
            REASON=$(ibmcloud ce buildrun get -n ${BUILD_RUN_NAME} --output json | jq -r '.status.conditions[] | select(.type=="Succeeded") | .reason // "Unknown"')
            
            echo "Build status: ${STATUS}, Reason: ${REASON}"
            
            if [ "$STATUS" = "True" ]; then
              echo "✅ Build completed successfully!"
              exit 0
            elif [ "$STATUS" = "False" ]; then
              echo "❌ Build failed with reason: ${REASON}"
              ibmcloud ce buildrun logs -n ${BUILD_RUN_NAME}
              exit 1
            fi
            
            echo "Build still in progress... (${ELAPSED}s elapsed)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "❌ Build timed out after ${MAX_WAIT} seconds"
          exit 1
      
      - name: Update Code Engine application
        run: |
          echo "Updating application ${{ env.CE_APP }} with new image..."
          ibmcloud ce app update --name ${{ env.CE_APP }} --image ${{ env.IMAGE_NAME }}
          
          echo "Application update command completed"
          echo "Note: 'Traffic is not yet migrated' message is normal - the new revision is being deployed"
      
      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting 30 seconds for new revision to become ready..."
          sleep 30
      
      - name: Verify deployment health
        run: |
          echo "Checking application health at ${{ env.HEALTH_ENDPOINT }}"
          
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i of $MAX_RETRIES..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" ${{ env.HEALTH_ENDPOINT }})
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)
            
            echo "HTTP Status: ${HTTP_CODE}"
            echo "Response: ${BODY}"
            
            if [ "$HTTP_CODE" = "200" ]; then
              STATUS=$(echo "$BODY" | jq -r '.status // "UNKNOWN"')
              if [ "$STATUS" = "UP" ]; then
                echo "✅ Health check passed! Application is UP"
                exit 0
              else
                echo "⚠️  Health check returned status: ${STATUS}"
              fi
            else
              echo "⚠️  Health check returned HTTP ${HTTP_CODE}"
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY} seconds..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "❌ Health check failed after ${MAX_RETRIES} attempts"
          exit 1
      
      - name: Display deployment info
        if: success()
        run: |
          echo "=========================================="
          echo "Deployment successful!"
          echo "=========================================="
          echo "Application: ${{ env.CE_APP }}"
          echo "Image: ${{ env.IMAGE_NAME }}"
          echo "Build run: ${{ steps.submit_build.outputs.build_run_name }}"
          echo "Health endpoint: ${{ env.HEALTH_ENDPOINT }}"
          echo "Live URL: https://payment-app.26rs7vqmzosm.us-south.codeengine.appdomain.cloud"
          echo "=========================================="
          
          # Show current app configuration
          ibmcloud ce app get --name ${{ env.CE_APP }}

# Made with Bob